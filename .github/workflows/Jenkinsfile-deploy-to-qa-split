pipeline {
    agent any

    stages {
        stage('Checkout Develop') {
            steps {
                git branch: 'develop', url: 'https://github.com/Cutber/DemoWeb.git'
            }
        }

        stage('Merge Develop into QA_Split') {
            steps {
                script {
                    powershell '''
                    # Configurar identidad en Git (evita errores)
                    git config --global user.name "Cutberto HernÃ¡ndez SÃ¡nchez"
                    git config --global user.email "cutberto.hdez.s@gmail.com"

                    # Verificar estado actual de las ramas
                    echo "ğŸ“Œ Verificando estado de las ramas..."
                    git fetch --all

                    # Cambiar a la rama QA_Split
                    echo "ğŸ“Œ Cambiando a la rama qa_split..."
                    git checkout qa_split

                    # Actualizar QA_Split con la Ãºltima versiÃ³n remota
                    echo "ğŸ“Œ Haciendo pull de QA_Split..."
                    git pull origin qa_split --ff-only

                    # Intentar el merge desde develop (manejando conflictos automÃ¡ticamente)
                    echo "ğŸ“Œ Intentando merge..."
                    git merge origin/develop -X theirs || echo "âš ï¸ Conflictos detectados, revisando..."

                    # Verificar si hay conflictos pendientes
                    if (git ls-files -u) {
                        echo "âŒ Hay conflictos sin resolver. Abortando el merge."
                        git merge --abort
                        exit 1
                    } else {
                        echo "âœ… Merge exitoso, subiendo cambios..."
                        git push origin qa_split
                    }
                    '''
                }
            }
        }

        stage('Deploy to QA_Split') {
            steps {
                echo 'ğŸš€ Desplegando en QA_Split...'
            }
        }
    }
}
