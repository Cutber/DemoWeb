name: Versioning

on:
  push:
    branches:
      - develop  # Se ejecuta cuando se hace push en develop

jobs:
  create-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del Código
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Necesario para que git log funcione correctamente

      - name: Obtener Última Versión
        id: version
        run: |
          LATEST_TAG=$(git describe --tags git rev-list --tags --max-count=1)
          echo "Última versión encontrada: $LATEST_TAG"
          if [[ -z "$LATEST_TAG" ]]; then
            NEW_TAG="v1.0.0"
          else
            NEW_TAG=$(echo $LATEST_TAG | awk -F. -v OFS=. '{$NF++; print}')
          fi
          echo "Nuevo tag generado: $NEW_TAG"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

      - name: Autenticar con GitHub
        run: |
          git config --global user.email "cutberto.hdez.s@gmail.com"
          git config --global user.name "Cutberto Hernández Sánchez"
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/Cutber/DemoWeb.git

      - name: Crear y Subir Nuevo Tag
        run: |
          git tag -a $NEW_TAG -m "Automated release: $NEW_TAG"
          git push origin $NEW_TAG
