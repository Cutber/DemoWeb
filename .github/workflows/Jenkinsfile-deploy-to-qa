pipeline {
    agent any

    environment {
        GIT_URL = 'https://github.com/Cutber/DemoWeb.git'
        GIT_BRANCH = 'develop'
    }

    stages {
        stage('Checkout Develop') {
            steps {
                script {
                    git branch: "${GIT_BRANCH}", url: "${GIT_URL}"
                }
            }
        }

        stage('Merge Develop into QA') {
            steps {
                script {
                    powershell '''
                    git config --global user.name "Cutberto Hern√°ndez S√°nchez"
                    git config --global user.email "cutberto.hdez.s@gmail.com"

                    Write-Output "üìå Verificando estado de las ramas..."
                    git fetch --all
                    git checkout qa
                    git pull origin qa 

                    Write-Output "üìå Verificando si hay cambios pendientes en develop..."
                    git fetch origin develop
                    DIFF=$(git diff HEAD..origin/develop)

                    if [[ -z "$DIFF" ]]; then
                        Write-Output "‚úÖ No hay cambios nuevos, omitiendo merge."
                    else
                        Write-Output "üìå Intentando merge..."
                        try {
                            git merge origin/develop -X theirs
                        } catch {
                            Write-Output "‚ö†Ô∏è Conflictos detectados. Necesita resoluci√≥n manual."
                            exit 1
                        }
                    fi

                    if [[ $(git rev-parse HEAD) != $(git rev-parse origin/qa) ]]; then
                        Write-Output "‚úÖ Subiendo cambios..."
                        git push origin qa
                    else
                        Write-Output "üöÄ No hay cambios nuevos en QA, omitiendo push."
                    fi
                    '''
                }
            }
        }

        stage('Deploy to QA') {
            steps {
                script {
                    if (currentBuild.result == null || currentBuild.result == 'SUCCESS') {
                        echo 'üöÄ Desplegando en QA...'
                    } else {
                        echo '‚ö†Ô∏è Despliegue omitido por errores en el merge.'
                    }
                }
            }
        }
    }
}
